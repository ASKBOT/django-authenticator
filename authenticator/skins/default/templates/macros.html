{%- macro user_score_and_badge_summary(user) -%}
    <span class="reputation-score"
          title="{{user.get_karma_summary}}"
    >{{user.reputation}}</span>
    {% if user.gold or user.silver or user.bronze %}
    <span title="{{user.get_badge_summary}}">
        {% if user.gold %}
        <span class='badge1'>&#9679;</span>
        <span class="badgecount">{{user.gold}}</span>
        {% endif %}
        {% if user.silver %}
        <span class='badge2'>&#9679;</span>
        <span class="badgecount">{{user.silver}}</span>
        {% endif %}
        {% if user.bronze %}
        <span class='badge3'>&#9679;</span>
        <span class="badgecount">{{user.bronze}}</span>
        {% endif %}
    </span>
    {% endif %}
{%- endmacro -%}

{%- macro user_long_score_and_badge_summary(user) -%}
    <a class="user-micro-info" 
       href="{{user.get_absolute_url()}}?sort=reputation"
    >{% trans %}karma:{% endtrans %} {{user.reputation}}</a>
    {%- if user.gold or user.silver or user.bronze %}
    <a class="user-micro-info"
       href="{{user.get_absolute_url()}}#badges"
    ><span title="{{user.get_badge_summary}}">{% trans %}badges:{% endtrans %}
        {% if user.gold %}
        <span class='badge1'>&#9679;</span>
        <span class="badgecount">{{user.gold}}</span>
        {% endif %}
        {% if user.silver %}
        <span class='badge2'>&#9679;</span>
        <span class="badgecount">{{user.silver}}</span>
        {% endif %}
        {% if user.bronze %}
        <span class='badge3'>&#9679;</span>
        <span class="badgecount">{{user.bronze}}</span>
        {%- endif -%}
    </span></a>
    {%- endif -%}
{%- endmacro -%}

{%- macro paginator(p, position='left') -%}{# p is paginator context dictionary #}
{% spaceless %}
    {% if p.is_paginated %}
        <div class="paginator" style="float:{{position}}">
        {% if p.has_previous %}
            <span class="prev"><a href="{{p.base_url}}page={{ p.previous }}{{ p.extend_url }}" title="{% trans %}previous{% endtrans %}">
        &laquo; {% trans %}previous{% endtrans %}</a></span>
        {% endif %}
        {% if not p.in_leading_range %}
            {% for num in p.pages_outside_trailing_range %}
                <span class="page"><a href="{{p.base_url}}page={{ num }}{{ p.extend_url }}" >{{ num }}</a></span>
            {% endfor %}
        ...
        {% endif %}
         
        {% for num in p.page_numbers %}
          {% if num == p.page and p.pages != 1%}
            <span class="curr" title="{% trans %}current page{% endtrans %}">{{ num }}</span>
          {% else %}
            <span class="page"><a href="{{p.base_url}}page={{ num }}{{ p.extend_url }}" title="{% trans %}page number {{num}}{% endtrans %}">{{ num }}</a></span>
          {% endif %}
        {% endfor %}
         
        {% if not p.in_trailing_range %}
            ...
            {% for num in p.pages_outside_leading_range|reverse %}
                <span class="page"><a href="{{p.base_url}}page={{ num }}{{ p.extend_url }}" title="{% trans %}page number {{ num }}{% endtrans %}">{{ num }}</a></span>
            {% endfor %}
        {% endif %}
        {% if p.has_next %}
            <span class="next"><a href="{{p.base_url}}page={{ p.next }}{{ p.extend_url }}" title="{% trans %}next page{% endtrans %}">{% trans %}next page{% endtrans %} &raquo;</a></span>
        {% endif %}
        </div> 
    {% endif %}
{% endspaceless %}
{%- endmacro -%}

{%- macro pagesize_switch(p, position='left') -%}{# p is paginator context #}
{% spaceless %}
{% if p.is_paginated %}
    <div class="paginator" style="float:{{position}}">
        <span class="text">{% trans %}posts per page{% endtrans %}</span>
        {% if p.page_size == 10 %}
            <span class="curr">10</span>
        {% else %}
            <span class="page"><a href="{{p.base_url}}page_size=10">10</a></span>
        {% endif %}
        
        {% if p.page_size == 30 %}
            <span class="curr">30</span>
        {% else %}
            <span class="page"><a href="{{p.base_url}}page_size=30">30</a></span>
        {% endif %}
        
        {% if p.page_size == 50 %}
            <span class="curr">50</span>
        {% else %}
            <span class="page"><a href="{{p.base_url}}page_size=50">50</a></span>
        {% endif %}
    </div> 
{% endif %}
{% endspaceless %}
{%- endmacro -%}

{%- macro gravatar(user, size) -%}
{% spaceless %}
<a style="text-decoration:none"
    href="{{user.get_absolute_url()}}"
><img class="gravatar" 
    width="{{size}}" height="{{size}}"
    src="http://www.gravatar.com/avatar/{{user.gravatar}}s?s={{size}}&amp;d=identicon&amp;r=PG"
    title="{{user.username}}" 
    alt="{% trans username=user.username %}{{username}} gravatar image{% endtrans %}" 
/></a>
{% endspaceless %}
{%- endmacro -%}

{%- macro post_contributor_info(post, contributor_type, is_wiki, wiki_min_rep) -%}
<div class='post-update-info'>
{# there is a whole bunch of trickery here, probably indicative of 
poor design of the data or methods on data objects #}
{% if contributor_type=="original_author" %}
    {% if is_wiki %}
        <p style="line-height:12px">
           {%- if post.__class__.__name__ == 'Question' -%}
                {%- trans %}asked{% endtrans %}
           {% elif post.__class__.__name__ == 'Answer' %}
                {%- trans %}answered{% endtrans %}
           {% else %}
                {%- trans %}posted{% endtrans %}
           {% endif %}
           <strong>{{post.added_at|diff_date}}</strong>
        </p>
        <img 
            src="{{'/images/wiki.png'|media}}"
            alt="{% trans %}this post is marked as community wiki{% endtrans %}"
            style="float:left"
        />
        <p class="tip">{% trans %}This post is a wiki.
        Anyone with karma &gt;{{wiki_min_rep}} is welcome to improve it.{% endtrans %}</p>
    {% else %}
        <p style="line-height:12px;">
            {# todo: access to class names needs to be removed here #}
            {% if post.__class__.__name__=="Question" %}
                {% trans %}asked{% endtrans %}
            {% elif post.__class__.name__=="Answer" %}
                {% trans %}answered{% endtrans %}
            {% else %}
                {% trans %}posted{% endtrans %}
            {% endif %}
            {% if post.__class__.__name__ in ('QuestionRevision', 'AnswerRevision') %}
                <strong>{{post.revised_at|diff_date}}</strong>
            {% else %}
                <strong>{{post.added_at|diff_date}}</strong>
            {% endif %}
        </p>
        {{ gravatar(post.author, 32) }}
        <p>{{post.author.get_profile_link()}}<br/>
        {{ user_score_and_badge_summary(post.author) }}</p>
    {% endif %}
{% else %}
    {% if post.__class__.__name__ in ('Question', 'Answer') %}
        {% set last_edited_at = post.last_edited_at %}
        {% set original_author = post.author %}
        {% set update_author = post.last_edited_by %}
    {% elif post.__class__.__name__ in ('QuestionRevision', 'AnswerRevision') %}
        {% set last_edited_at = post.revised_at %}
        {% set original_author = None %}{# fake value to force display widget in the revision views #}
        {% set update_author = post.author %}
    {% endif %}
    {% if last_edited_at %}
        <p style="line-height:12px;">
            <a 
        {% if post.__class__.__name__ == 'Question' %}
            href="{% url question_revisions post.id %}"
        {% else %}
            href="{% url answer_revisions post.id %}"
        {% endif %}
            >{% trans %}updated{% endtrans %} <strong>{{ last_edited_at|diff_date }}</strong></a>
        </p>
        {% if original_author != update_author or is_wiki %}
            {{ gravatar(update_author, 32) }}
            <p style="float:left">{{update_author.get_profile_link()}}<br/>
            {{ user_score_and_badge_summary(update_author) }}</p>
        {% endif %}
    {% endif %}
{% endif %}
</div>
{%- endmacro -%}

{%- macro question_summary(question, extra_class=None) -%}
    <div class="short-summary{% if extra_class %} {{extra_class}}{% endif %}">
        <div class="counts">
            <div class="votes">
                <span 
                    class="item-count 
                        {% if question.score == 0 -%}
                            no-votes
                        {% else -%}
                            some-votes
                        {%- endif -%}"
                >{{question.score|humanize_counter}}</span>
                <div>
                {% trans cnt=question.score %}vote{% pluralize %}votes{% endtrans %}
                </div>
            </div>
            <div class="votes"> 
                <span 
                    class="item-count
                    {% if question.answer_count == 0 -%}
                        no-answers
                    {% else -%}
                        {%- if question.answer_accepted -%}
                            accepted
                        {%- else -%}
                            some-answers
                        {%- endif -%}
                    {%- endif -%}"
                >{{question.answer_count|humanize_counter}}{% if question.answer_accepted%}&#10003;{% endif %}</span>
                <div>
                {% trans cnt=question.answer_count %}answer{% pluralize %}answers{% endtrans %}
                </div>
            </div>
            <div class="votes">
                 <span class="item-count
                 {% if question.view_count == 0 -%}
                    no-views
                 {% else -%}
                    some-views
                 {%- endif -%}"
                 >{{question.view_count|humanize_counter}}</span>
                <div>
                {% trans cnt=question.view_count %}view{% pluralize %}views{% endtrans %}
                </div>
            </div>
        </div>
        <h2><a title="{{question.summary|escape}}" href="{{ question.get_absolute_url() }}">{{question.get_question_title()|escape}}</a></h2>
        <div class="userinfo">
            <span class="relativetime" title="{{question.last_activity_at}}">{{ question.last_activity_at|diff_date }}</span>
            <a href="{% url user_profile question.last_activity_by.id, question.last_activity_by.username|slugify %}">{{question.last_activity_by.username}}</a>
            {#{user_score_and_badge_summary(question.last_activity_by)}#}
        </div>
        <div class="tags">
            {% for tag in question.get_tag_names() %}
            <a href="{% url questions %}?tags={{tag|urlencode}}" title="{% trans %}see questions tagged '{{ tag }}'{% endtrans %}" rel="tag">{{ tag }}</a>
            {% endfor %}
        </div>
    </div>
{%- endmacro -%}

{%- macro comment_list(comments = None, user = None) -%}
    {% for comment in comments %}
    <div class="comment" id="comment-{{comment.id}}">
        {{comment.html}} -
        <a 
            class="author" 
            href="{{comment.user.get_profile_url()}}"
        >{{comment.user.username}}</a>
        <span class="age">&nbsp;({{comment.added_at|diff_date}})</span>
        {% if user|can_edit_comment(comment) %}
            <a class="edit">{% trans %}edit{% endtrans %}</a>
        {% endif %}
        {% if user|can_delete_comment(comment) %}
            <img class="delete-icon" 
                src="{{"/images/close-small.png"|media}}"
                title="{% trans %}delete this comment{% endtrans %}"
            />
        {% endif %}
    </div>
    {% endfor %}
{%- endmacro -%}

{%- macro add_or_show_comments_button(post = None, can_post = None, max_comments = None, widget_id = None) -%}
    <script type="text/javascript">
        askbot['data']['{{widget_id}}'] = {
            can_post: {% if can_post %}true{% else %}false{% endif %},
            truncated: {% if post.comment_count > max_comments %}true{% else %}false{% endif %}
        };
    </script>
    {% if post.comment_count > max_comments %}
        {% set remaining_comments = post.comment_count - max_comments %}
        <a class="button">
        {% if can_post %}
            {% trans %}add comment{% endtrans %} /
            {% trans counter=remaining_comments %}see <strong>{{counter}}</strong> more{% pluralize %}see <strong>{{counter}}</strong> more{% endtrans %}
        {% else %}
            {% trans counter=remaining_comments %}see <strong>{{counter}}</strong> more comment{% pluralize %}see <strong>{{counter}}</strong> more comments
            {% endtrans %}
        {% endif %}
        </a>
    {% elif can_post %}
        <a class="button">{% trans %}add comment{% endtrans %}</a>
    {% endif %}
{%- endmacro -%}

{%- macro post_comments_widget(post=None, show_post = None, show_comment = None, comment_order_number = None, user=None, max_comments=None) -%}
    {% spaceless %}
    {% set widget_id = 'comments-for-' + post.post_type + '-' + post.id|string %}
    <div class="comments" id="{{widget_id}}">
        <div class="content">
            {% if show_post == post and show_comment %}
                {% if comment_order_number > max_comments %}
                    {% set comments = post.get_comments()[:comment_order_number] %}
                    {{ comment_list(comments = comments, user = user) }}
                {% else %}
                    {% set comments = post.get_comments()[:max_comments] %}
                    {{ comment_list(comments = comments, user = user) }}
                {% endif %}
            {% else %}
                {% set comments = post.get_comments()[:max_comments] %}
                {{ comment_list(comments = comments, user = user) }}
            {% endif %}
        </div>
        <div class="controls">
            {% set can_post = user|can_post_comment(post) %}
            {% if show_post == post and show_comment %}
                {% if comment_order_number > max_comments %}
                    {{
                        add_or_show_comments_button(
                                            post = post,
                                            can_post = can_post,
                                            max_comments = comment_order_number,
                                            widget_id = widget_id
                                        )
                    }}
                {% else %}
                    {{
                        add_or_show_comments_button(
                                            post = post,
                                            can_post = can_post,
                                            max_comments = max_comments,
                                            widget_id = widget_id
                                        )
                    }}
                {% endif %}
            {% else %}
                {{
                    add_or_show_comments_button(
                                        post = post,
                                        can_post = can_post,
                                        max_comments = max_comments,
                                        widget_id = widget_id
                                    )
                }}
            {% endif %}
        </div>
    </div>
    {% endspaceless %}
{%- endmacro -%}

{%- macro reversible_sort_button(button_sort_criterium=None, asc_tooltip=None,
            desc_tooltip=None, label=None, current_sort_method=None) -%}
{# 
    sort button where descending sort is default
    and the search method is togglable between ascending and descending 
    buttons are rendered as links with id constructed as
    "by_" + button_sort_criterium
    class "on" is added when current_sort_method is one of
    button_sort_criterium + "asc" or "desc"
#}
    {% set key_name = button_sort_criterium %}
    {% set sort = current_sort_method %}
    {% if sort == key_name + "-asc" %}{# "worst" first #}
    <a id="by_{{key_name}}" 
        href="?sort={{key_name}}-desc" 
        class="on" 
        title="{{desc_tooltip}}">{{label}} &#9650;</a>
    {% elif sort == key_name + "-desc" %}{# "best first" #}
    <a id="by_{{key_name}}"
        href="?sort={{key_name}}-asc" 
        class="on"
        title="{{asc_tooltip}}">{{label}} &#9660;</a>
    {% else %}{# default, when other button is active #}
    <a id="by_{{key_name}}"
        href="?sort={{key_name}}-desc" 
        class="off"
        title="{{desc_tooltip}}">{{label}}</a>
    {% endif %}
    <script type="text/javascript">{# need to pass on text translations to js #}
        var sortButtonData = sortButtonData || {};
        sortButtonData["{{key_name}}"] = {
            label: "{{label}}",
            asc_tooltip: "{{asc_tooltip}}",
            desc_tooltip: "{{desc_tooltip}}",
        };
    </script>
{%- endmacro %}

{%- macro edit_post(post_form, wiki_on, post_type=None, edit_title=False) -%}
    {% if edit_title %}
        <div class="form-item">
            <label for="id_title" ><strong>{{ post_form.title.label_tag() }}:</strong></label> <span class="form-error"></span><br/>
            {{ post_form.title }} {{ post_form.title.errors }}
            <div class="title-desc">
                {{ post_form.title.help_text }}
            </div>
        </div>
    {% endif %}
    <div id="wmd-button-bar" class="wmd-panel"></div>
    <div class="form-item">
        {{ post_form.text }}{# this element is resizable and will be wrapped by js #}
        {% if wiki_on %}
            <div style="margin-right:5px;float:right;font-weight:normal;cursor:help" 
                title="{{post_form.wiki.help_text}}">
                {{ post_form.wiki }} 
                {{ post_form.wiki.label_tag() }} 
            </div>
        {% endif %}
        <label for="editor" class="form-error">{{ post_form.text.errors }}</label>
    </div>
    {# need label element for resizable input, b/c form validation won't find span #}
    {% if post_type == 'question' %}
        <div class="form-item">
            <strong>{{ post_form.tags.label_tag() }}:</strong>
            {% trans %}(required){% endtrans %}
            <span class="form-error">{{ post_form.tags.errors }}</span><br/>
            {{ post_form.tags }}
            <div class="title-desc">
                {{ post_form.tags.help_text }}
            </div>
        </div>
    {% endif %}
    {% if 'summary' in post_form['fields'] %}
        <div class="form-item">
            <strong>{{ post_form.summary.label_tag() }}</strong> <br/>
            {{ post_form.summary }}
            <div class="title-desc">
                {{ post_form.summary.help_text }}
            </div>
            <div class="form-error" >{{ post_form.summary.errors }}</div>
        </div>
    {% endif %}
    <div class="preview-toggle">
        <span 
            id="pre-collapse" 
            title="{% trans %}Toggle the real time Markdown editor preview{% endtrans %}"
        >
            [{% trans %}hide preview{% endtrans %}]
        </span>
    </div>
    <div id="previewer" class="wmd-preview"></div>
{%- endmacro -%}
